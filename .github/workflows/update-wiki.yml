name: Publish AI Review Generator Docs To Wiki

on:
  schedule:
    # Sunday 21:30 UTC = Monday 01:30 Iran
    - cron: "30 21 * * 0"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Clone Wiki (with auth)
        run: |
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/intellsoft/wordpress-automatic-AI-review-generator.wiki.git wiki

      - name: Fetch source page
        run: |
          curl -L 'https://intellsoft.ir/docs/%d8%b1%d8%a7%d9%87%d9%86%d9%85%d8%a7%db%8c-%d8%a7%d9%81%d8%b2%d9%88%d9%86%d9%87-%d9%88%d8%b1%d8%af%d9%be%d8%b1%d8%b3-%d8%aa%d9%88%d9%84%db%8c%d8%af-%d8%ae%d9%88%d8%af%da%a9%d8%a7%d8%b1-%d9%86%d8%b8/' -o index.html

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install beautifulsoup4 requests

      - name: Extract nav-link articles using Python
        run: |
          mkdir -p articles
          python3 - <<PYTHON
          import requests
          from bs4 import BeautifulSoup

          with open("index.html", encoding="utf-8") as f:
              soup = BeautifulSoup(f, "html.parser")

          links = soup.find_all("a", class_="nav-link")

          with open("articles/list.txt", "w", encoding="utf-8") as out:
              for a in links:
                  href = a.get("href")
                  title = a.get_text(strip=True)
                  if href and title:
                      out.write(f"{href}\t{title}\n")
          PYTHON

      - name: Publish new articles to Wiki
        run: |
          while IFS=$'\t' read -r url title; do
            slug=$(basename "$url")
            file="wiki/$slug.md"

            if [ -f "$file" ]; then
              echo "Already exists: $title"
              continue
            fi

            echo "Publishing: $title"

            curl -L "$url" -o article.html

            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØªÙ† Ù…Ù‚Ø§Ù„Ù‡ Ø¨ÛŒÙ† <article> ØªØ§ </article>
            sed -n '/<article/,/<\/article>/p' article.html \
              | sed 's/<[^>]*>//g' > body.txt

            {
              echo "# $title"
              echo ""
              cat body.txt
              echo ""
              echo "---"
              echo "ðŸ”— **Ù…Ù†Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ù…Ù‚Ø§Ù„Ù‡:**"
              echo ""
              echo "ðŸ‘‰ [$url]($url?utm_source=github_wiki&utm_medium=wiki&utm_campaign=wordpress_ai_review_docs)"
            } > "$file"

          done < articles/list.txt

      - name: Commit and push to Wiki
        run: |
          cd wiki
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Auto publish new documentation articles to Wiki" || exit 0
          git push
